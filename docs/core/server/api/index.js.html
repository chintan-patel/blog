<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../", thisFile = "core/server/api/index.js", defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>
  <script src="../../../fileSearch.js"></script>
  <link rel="stylesheet" href="../../../fileSearch.css" />
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#ghost%20data%20api">Ghost Data API</a>
      </div>
      <div class="heading h3">
        <a href="#init">Init</a>
      </div>
      <div class="heading h3">
        <a href="#cache%20invalidation%20header">Cache Invalidation Header</a>
      </div>
      <div class="heading h3">
        <a href="#location%20header">Location Header</a>
      </div>
      <div class="heading h3">
        <a href="#content%20disposition%20header">Content Disposition Header</a>
      </div>
      <div class="heading h3">
        <a href="#http">HTTP</a>
      </div>
      <div class="heading h2">
        <a href="#public%20api">Public API</a>
      </div>
      <div class="heading h2">
        <a href="#api%20methods">API Methods</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
<div class="pilwrap" id="ghost%20data%20api">
  <h1>
    <a href="#ghost%20data%20api" name="ghost%20data%20api" class="pilcrow">&#182;</a>
    Ghost Data API
  </h1>
</div>


<p>Provides access from anywhere to the Ghost data layer.</p>

<p>Ghost's JSON API is integral to the workings of Ghost, regardless of whether you want to access data internally,
from a theme, an app, or from an external app, you'll use the Ghost JSON API to do so.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">_</span>              <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;lodash&#39;</span><span class="p">),</span>
    <span class="nx">config</span>         <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../config&#39;</span><span class="p">),</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>Include Endpoints</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">configuration</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./configuration&#39;</span><span class="p">),</span>
    <span class="nx">db</span>             <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./db&#39;</span><span class="p">),</span>
    <span class="nx">mail</span>           <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./mail&#39;</span><span class="p">),</span>
    <span class="nx">notifications</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./notifications&#39;</span><span class="p">),</span>
    <span class="nx">posts</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./posts&#39;</span><span class="p">),</span>
    <span class="nx">roles</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./roles&#39;</span><span class="p">),</span>
    <span class="nx">settings</span>       <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./settings&#39;</span><span class="p">),</span>
    <span class="nx">tags</span>           <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./tags&#39;</span><span class="p">),</span>
    <span class="nx">clients</span>        <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./clients&#39;</span><span class="p">),</span>
    <span class="nx">themes</span>         <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./themes&#39;</span><span class="p">),</span>
    <span class="nx">users</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./users&#39;</span><span class="p">),</span>
    <span class="nx">slugs</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./slugs&#39;</span><span class="p">),</span>
    <span class="nx">authentication</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./authentication&#39;</span><span class="p">),</span>
    <span class="nx">uploads</span>        <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./upload&#39;</span><span class="p">),</span>
    <span class="nx">dataExport</span>     <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../data/export&#39;</span><span class="p">),</span>

    <span class="nx">http</span><span class="p">,</span>
    <span class="nx">addHeaders</span><span class="p">,</span>
    <span class="nx">cacheInvalidationHeader</span><span class="p">,</span>
    <span class="nx">locationHeader</span><span class="p">,</span>
    <span class="nx">contentDispositionHeader</span><span class="p">,</span>
    <span class="nx">init</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="init">
  <h3>
    <a href="#init" name="init" class="pilcrow">&#182;</a>
    Init
  </h3>
</div>


<p>Initialise the API - populate the settings cache</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Promise(Settings)</span>
      <span>Resolves to Settings Collection</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">updateSettingsCache</span><span class="p">();</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="cache%20invalidation%20header">
  <h3>
    <a href="#cache%20invalidation%20header" name="cache%20invalidation%20header" class="pilcrow">&#182;</a>
    Cache Invalidation Header
  </h3>
</div>


<p>Calculate the header string for the X-Cache-Invalidate: header.
The resulting string instructs any cache in front of the blog that request has occurred which invalidates any cached
versions of the listed URIs.</p>
  </div>
  <div class="body"><p><code>/*</code> is used to mean the entire cache is invalid</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private</span>
    </div>
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">req</span>
      <span class="dox_type">Express.request</span>
      <span>Original HTTP Request</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">result</span>
      <span class="dox_type">Object</span>
      <span>API method result</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">String</span>
      <span>Resolves to header string</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">cacheInvalidationHeader</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">cacheInvalidationHeader</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">parsedUrl</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">_parsedUrl</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\/|\/$/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span>
        <span class="nx">method</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span>
        <span class="nx">endpoint</span> <span class="o">=</span> <span class="nx">parsedUrl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">cacheInvalidate</span><span class="p">,</span>
        <span class="nx">jsonResult</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">toJSON</span> <span class="o">?</span> <span class="nx">result</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="o">:</span> <span class="nx">result</span><span class="p">,</span>
        <span class="nx">post</span><span class="p">,</span>
        <span class="nx">hasStatusChanged</span><span class="p">,</span>
        <span class="nx">wasDeleted</span><span class="p">,</span>
        <span class="nx">wasPublishedUpdated</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;POST&#39;</span> <span class="o">||</span> <span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;PUT&#39;</span> <span class="o">||</span> <span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">endpoint</span> <span class="o">===</span> <span class="s1">&#39;settings&#39;</span> <span class="o">||</span> <span class="nx">endpoint</span> <span class="o">===</span> <span class="s1">&#39;users&#39;</span> <span class="o">||</span> <span class="nx">endpoint</span> <span class="o">===</span> <span class="s1">&#39;db&#39;</span> <span class="o">||</span> <span class="nx">endpoint</span> <span class="o">===</span> <span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cacheInvalidate</span> <span class="o">=</span> <span class="s1">&#39;/*&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">endpoint</span> <span class="o">===</span> <span class="s1">&#39;posts&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">post</span> <span class="o">=</span> <span class="nx">jsonResult</span><span class="p">.</span><span class="nx">posts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="nx">hasStatusChanged</span> <span class="o">=</span> <span class="nx">post</span><span class="p">.</span><span class="nx">statusChanged</span><span class="p">;</span>
            <span class="nx">wasDeleted</span> <span class="o">=</span> <span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Invalidate cache when post was updated but not when post is draft</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">wasPublishedUpdated</span> <span class="o">=</span> <span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;PUT&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">post</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="s1">&#39;published&#39;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>Remove the statusChanged value from the response</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">delete</span> <span class="nx">post</span><span class="p">.</span><span class="nx">statusChanged</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>Don't set x-cache-invalidate header for drafts</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">hasStatusChanged</span> <span class="o">||</span> <span class="nx">wasDeleted</span> <span class="o">||</span> <span class="nx">wasPublishedUpdated</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">cacheInvalidate</span> <span class="o">=</span> <span class="s1">&#39;/*&#39;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">cacheInvalidate</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">routeKeywords</span><span class="p">.</span><span class="nx">preview</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">post</span><span class="p">.</span><span class="nx">uuid</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">cacheInvalidate</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="location%20header">
  <h3>
    <a href="#location%20header" name="location%20header" class="pilcrow">&#182;</a>
    Location Header
  </h3>
</div>

  </div>
  <div class="body"><p>If the API request results in the creation of a new object, construct a Location: header which points to the new
resource.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private</span>
    </div>
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">req</span>
      <span class="dox_type">Express.request</span>
      <span>Original HTTP Request</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">result</span>
      <span class="dox_type">Object</span>
      <span>API method result</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">String</span>
      <span>Resolves to header string</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">locationHeader</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">locationHeader</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">apiRoot</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">urlFor</span><span class="p">(</span><span class="s1">&#39;api&#39;</span><span class="p">),</span>
        <span class="nx">location</span><span class="p">,</span>
        <span class="nx">newObject</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;POST&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">newObject</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">posts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="nx">location</span> <span class="o">=</span> <span class="nx">apiRoot</span> <span class="o">+</span> <span class="s1">&#39;/posts/&#39;</span> <span class="o">+</span> <span class="nx">newObject</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;/?status=&#39;</span> <span class="o">+</span> <span class="nx">newObject</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;notifications&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">newObject</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">notifications</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="nx">location</span> <span class="o">=</span> <span class="nx">apiRoot</span> <span class="o">+</span> <span class="s1">&#39;/notifications/&#39;</span> <span class="o">+</span> <span class="nx">newObject</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">newObject</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">users</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="nx">location</span> <span class="o">=</span> <span class="nx">apiRoot</span> <span class="o">+</span> <span class="s1">&#39;/users/&#39;</span> <span class="o">+</span> <span class="nx">newObject</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">newObject</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="nx">location</span> <span class="o">=</span> <span class="nx">apiRoot</span> <span class="o">+</span> <span class="s1">&#39;/tags/&#39;</span> <span class="o">+</span> <span class="nx">newObject</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">location</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="content%20disposition%20header">
  <h3>
    <a href="#content%20disposition%20header" name="content%20disposition%20header" class="pilcrow">&#182;</a>
    Content Disposition Header
  </h3>
</div>


<p>create a header that invokes the 'Save As' dialog in the browser when exporting the database to file. The 'filename'
parameter is governed by <a href="http://tools.ietf.org/html/rfc6266#section-4.3">RFC6266</a>.</p>
  </div>
  <div class="body"><p>For encoding whitespace and non-ISO-8859-1 characters, you MUST use the "filename*=" attribute, NOT "filename=".
Ideally, both. Examples: <a href='http://tools.ietf.org/html/rfc6266#section-5'>http://tools.ietf.org/html/rfc6266#section-5</a></p>

<p>We'll use ISO-8859-1 characters here to keep it simple.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <a href="http://tools.ietf.org/html/rfc598">http://tools.ietf.org/html/rfc598</a>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">string
</span>
      <span>{string}</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">contentDispositionHeader</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">contentDispositionHeader</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">dataExport</span><span class="p">.</span><span class="nx">fileName</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="nx">then</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;Attachment; filename=&quot;&#39;</span> <span class="o">+</span> <span class="nx">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="nx">addHeaders</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">addHeaders</span><span class="p">(</span><span class="nx">apiMethod</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cacheInvalidation</span><span class="p">,</span>
        <span class="nx">location</span><span class="p">,</span>
        <span class="nx">contentDisposition</span><span class="p">;</span>

    <span class="nx">cacheInvalidation</span> <span class="o">=</span> <span class="nx">cacheInvalidationHeader</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cacheInvalidation</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="s1">&#39;X-Cache-Invalidate&#39;</span><span class="o">:</span> <span class="nx">cacheInvalidation</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;POST&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">location</span> <span class="o">=</span> <span class="nx">locationHeader</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">location</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">Location</span><span class="o">:</span> <span class="nx">location</span><span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>The location header indicates that a new object was created.
In this case the status code should be 201 Created</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">apiMethod</span> <span class="o">===</span> <span class="nx">db</span><span class="p">.</span><span class="nx">exportContent</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">contentDisposition</span> <span class="o">=</span> <span class="nx">contentDispositionHeader</span><span class="p">()</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="nx">addContentDispositionHeader</span><span class="p">(</span><span class="nx">header</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>Add Content-Disposition Header</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="nx">apiMethod</span> <span class="o">===</span> <span class="nx">db</span><span class="p">.</span><span class="nx">exportContent</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
                        <span class="s1">&#39;Content-Disposition&#39;</span><span class="o">:</span> <span class="nx">header</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">contentDisposition</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="http">
  <h3>
    <a href="#http" name="http" class="pilcrow">&#182;</a>
    HTTP
  </h3>
</div>

  </div>
  <div class="body"><p>Decorator for API functions which are called via an HTTP request. Takes the API method and wraps it so that it gets
data from the request and returns a sensible JSON response.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public</span>
    </div>
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">apiMethod</span>
      <span class="dox_type">Function</span>
      <span>API method to call</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Function</span>
      <span>middleware format function to be called by the route when a matching request is made</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">http</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">http</span><span class="p">(</span><span class="nx">apiMethod</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="nx">apiHandler</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>We define 2 properties for using as arguments in API calls:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
            <span class="nx">options</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">context</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">user</span><span class="o">:</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="o">?</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="o">:</span> <span class="kc">null</span>
                <span class="p">}</span>
            <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>If this is a GET, or a DELETE, req.body should be null, so we only have options (route and query params)
If this is a PUT, POST, or PATCH, req.body is an object</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">object</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">object</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
            <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">apiMethod</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="nx">tap</span><span class="p">(</span><span class="kd">function</span> <span class="nx">onSuccess</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>Add X-Cache-Invalidate, Location, and Content-Disposition headers</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">return</span> <span class="nx">addHeaders</span><span class="p">(</span><span class="nx">apiMethod</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="p">(</span><span class="nx">response</span> <span class="o">||</span> <span class="p">{}));</span>
        <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="nx">then</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>Send a properly formatting HTTP response containing the data with correct headers</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">response</span> <span class="o">||</span> <span class="p">{});</span>
        <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="nx">onAPIError</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>To be handled by the API middleware</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">next</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">};</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="public%20api">
  <h2>
    <a href="#public%20api" name="public%20api" class="pilcrow">&#182;</a>
    Public API
  </h2>
</div>

  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>Extras</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">init</span><span class="o">:</span> <span class="nx">init</span><span class="p">,</span>
    <span class="nx">http</span><span class="o">:</span> <span class="nx">http</span><span class="p">,</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>API Endpoints</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">configuration</span><span class="o">:</span> <span class="nx">configuration</span><span class="p">,</span>
    <span class="nx">db</span><span class="o">:</span> <span class="nx">db</span><span class="p">,</span>
    <span class="nx">mail</span><span class="o">:</span> <span class="nx">mail</span><span class="p">,</span>
    <span class="nx">notifications</span><span class="o">:</span> <span class="nx">notifications</span><span class="p">,</span>
    <span class="nx">posts</span><span class="o">:</span> <span class="nx">posts</span><span class="p">,</span>
    <span class="nx">roles</span><span class="o">:</span> <span class="nx">roles</span><span class="p">,</span>
    <span class="nx">settings</span><span class="o">:</span> <span class="nx">settings</span><span class="p">,</span>
    <span class="nx">tags</span><span class="o">:</span> <span class="nx">tags</span><span class="p">,</span>
    <span class="nx">clients</span><span class="o">:</span> <span class="nx">clients</span><span class="p">,</span>
    <span class="nx">themes</span><span class="o">:</span> <span class="nx">themes</span><span class="p">,</span>
    <span class="nx">users</span><span class="o">:</span> <span class="nx">users</span><span class="p">,</span>
    <span class="nx">slugs</span><span class="o">:</span> <span class="nx">slugs</span><span class="p">,</span>
    <span class="nx">authentication</span><span class="o">:</span> <span class="nx">authentication</span><span class="p">,</span>
    <span class="nx">uploads</span><span class="o">:</span> <span class="nx">uploads</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="api%20methods">
  <h2>
    <a href="#api%20methods" name="api%20methods" class="pilcrow">&#182;</a>
    API Methods
  </h2>
</div>

  </div>
  <div class="body"><p>Most API methods follow the BREAD pattern, although not all BREAD methods are available for all resources.
Most API methods have a similar signature, they either take just <code>options</code>, or both <code>object</code> and <code>options</code>.
For RESTful resources <code>object</code> is always a model object of the correct type in the form <code>name: [{object}]</code>
<code>options</code> is an object with several named properties, the possibilities are listed for each method.</p>

<p>Read / Edit / Destroy routes expect some sort of identifier (id / slug / key) for which object they are handling</p>

<p>All API methods take a context object as one of the options:</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">typedef</div>
    <div class="dox_tag_detail">
      <span>context
Context provides information for determining permissions. Usually a user, but sometimes an app, or the internal flag</span>
    </div>
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">user</span>
      <span class="dox_type">Number</span>
      <span>(optional)</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">app</span>
      <span class="dox_type">String</span>
      <span>(optional)</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">internal</span>
      <span class="dox_type">Boolean</span>
      <span>(optional)</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
